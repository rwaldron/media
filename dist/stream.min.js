/*! stream - v0.1.0 - 2012-08-29
* https://github.com/rwldrn/stream
* Copyright (c) 2012 Rick Waldron; Licensed MIT */
(function(a){function b(){}b.prototype.emit=function(){var a,b,c,d;a=arguments[0],c=[].slice.call(arguments,1);if(!this._events)return this._events={},this;b=this._events[a];if(b&&b.length){d=b.slice();while(d.length)d.shift().apply(this,c)}return this},b.prototype.on=function(a,b){return this._events||(this._events={}),this._events[a]||(this._events[a]=[]),this._events[a].push(b),this},b.prototype.once=function(a,b){return this.on(a,function c(){this.off(a,c),b.apply(this,[].slice.call(arguments))})},b.prototype.off=function(a,b){if(!this._events||!this._events[a])return this;var c=this._events[a];return b?this._events[a].splice(c.indexOf(b),1):delete this._events[a],this},a.EventEmitter=b})(this),function(a){function c(a){b.put.call(this,a),this.source=new MediaSource,this.media===undefined&&document.body.appendChild(this.media=document.createElement("video")),typeof a.media=="string"&&(this.media=document.querySelector(a.media)),this.chunks===undefined&&(this.chunks=c.CHUNKS),this.media.src=URL.createObjectURL(this.source),this.buffer=null,this.blob=null,this.source.addEventListener("webkitsourceopen",function(a){this.emit("sourceopen",{target:this,data:a}),this.buffer=this.source.addSourceBuffer('video/webm; codecs="vorbis,vp8"'),this.request(function(a){this.emit("response",{target:this,data:a}),this.blob=new Blob([new Uint8Array(a)],{type:"video/webm"}),this.blob.chunkSize=Math.ceil(this.blob.size/this.chunks),this.emit("blobcreate",{target:this,data:this.blob}),this.read()})}.bind(this),!1)}var b;b={put:function(a){return Object.getOwnPropertyNames(a).forEach(function(b){this[b]=a[b]},this),this},assign:function(a,c){var d=b.put.call({},a);return b.put.call(d,c)}},c.prototype=Object.create(EventEmitter.prototype),c.CHUNKS=5,c.prototype.request=function(a){var b=new XMLHttpRequest;b.onload=function(c){b.readyState===4&&b.status===200&&a.call(this,b.response)}.bind(this),b.open("GET",this.file,!0),b.responseType="arraybuffer",b.send()},c.prototype.read=function(a){var b,c;a=a===undefined?-1:a,++a===this.chunks?this.source.endOfStream():(b=new FileReader,c=this.blob.chunkSize*a,b.onprogress=function(a){this.emit("progress",{target:this,data:a})}.bind(this),b.onload=function(c){this.emit("data",{target:this,data:c}),this.buffer.append(new Uint8Array(b.result)),this.media.paused&&this.media.play(),this.read(a)}.bind(this),b.readAsArrayBuffer(this.blob.slice(c,c+this.blob.chunkSize)))},a.Stream=c}(this);